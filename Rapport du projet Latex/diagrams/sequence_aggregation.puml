@startuml sequence_aggregation
!theme plain
title Diagramme de séquence : Job d'agrégation quotidienne

participant "Scheduler" as Scheduler
participant "Job Agrégation" as Job
participant "Service" as Service
participant "DAO" as DAO
participant "Base de Données" as DB

Scheduler -> Job: Déclencher à 00:30
activate Job

Job -> Service: aggregerDonneesJournee()
activate Service

Service -> DAO: Récupérer tous les utilisateurs
activate DAO

DAO -> DB: SELECT utilisateurs
activate DB
DB --> DAO: Liste utilisateurs
deactivate DB

DAO --> Service: Utilisateurs
deactivate DAO

loop Pour chaque utilisateur
    Service -> Service: Récupérer données du jour
    Service -> Service: Calculer statistiques\n(somme, moyenne, max, coût)
    
    alt Données existantes
        Service -> DAO: Créer HistoriqueConsommation
        activate DAO
        DAO -> DB: INSERT historique
        activate DB
        DB --> DAO: OK
        deactivate DB
        DAO --> Service: Succès
        deactivate DAO
        
        Service -> Service: Vérifier seuils alertes
    end
end

Service --> Job: Agrégation complète
deactivate Service

Job -> Job: Log résumé
deactivate Job

note over Scheduler, DB
    Exécution : 00:30 quotidiennement
    Durée : < 5 minutes (1000 users)
    Charge : Heures creuses
end note

@enduml
